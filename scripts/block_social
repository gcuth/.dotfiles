#!/usr/bin/env bash
# =============================================================================
# BLOCK SOCIAL - Distraction Site Blocker
# =============================================================================
# Blocks social media and other distracting websites by modifying /etc/hosts.
# Uses Steven Black's hosts file as a base, then adds custom blocked sites.
#
# Usage:
#   sudo block_social              # Enable blocking
#   sudo block_social --unblock    # Restore default hosts file
#   sudo block_social --status     # Show current blocking status
#   block_social --list            # List blocked sites (no sudo)
#   block_social --help            # Show help
#
# Note: Requires sudo to modify /etc/hosts
#
# Dependencies:
#   - curl (for downloading hosts file)
#
# =============================================================================

set -euo pipefail

# -----------------------------------------------------------------------------
# CONFIGURATION
# -----------------------------------------------------------------------------

readonly HOSTS_FILE="/etc/hosts"
readonly BACKUP_FILE="/etc/hosts.backup"
readonly HOSTS_URL="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/social/hosts"

# Shared blocked sites configuration
readonly BLOCKED_SITES_CONFIG="${DOTFILES_DIR:-$HOME/.dotfiles}/config/blocked-sites.json"

# Load blocked sites from shared config file
load_blocked_sites() {
    if [[ -f "$BLOCKED_SITES_CONFIG" ]]; then
        # Extract all sites from all categories using jq or python
        if command -v jq &>/dev/null; then
            jq -r '.streaming[], .social[], .news[], .shopping[], .misc[]' "$BLOCKED_SITES_CONFIG" 2>/dev/null
        elif command -v python3 &>/dev/null; then
            python3 -c "
import json
with open('$BLOCKED_SITES_CONFIG') as f:
    d = json.load(f)
    for key in ['streaming', 'social', 'news', 'shopping', 'misc']:
        for site in d.get(key, []):
            print(site)
" 2>/dev/null
        else
            # Fallback to hardcoded list if no JSON parser available
            echo "youtube.com netflix.com reddit.com twitter.com x.com instagram.com facebook.com tiktok.com" | tr ' ' '\n'
        fi
    else
        # Fallback if config file doesn't exist
        echo "youtube.com netflix.com reddit.com twitter.com x.com instagram.com facebook.com tiktok.com" | tr ' ' '\n'
    fi
}

# Custom sites to block (loaded from shared config)
# shellcheck disable=SC2207
CUSTOM_BLOCKED_SITES=($(load_blocked_sites))

# -----------------------------------------------------------------------------
# HELPERS
# -----------------------------------------------------------------------------

print_usage() {
    cat << 'EOF'
Usage: block_social [OPTION]

Block distracting websites by modifying /etc/hosts.

Options:
  --unblock, -u    Restore the default hosts file from backup
  --status, -s     Show current blocking status
  --list, -l       List all sites that will be blocked
  --help, -h       Show this help message

Examples:
  sudo block_social           # Enable blocking
  sudo block_social --unblock # Restore default hosts
  block_social --list         # Show blocked sites (no sudo needed)

Note: Blocking and unblocking require sudo privileges.
EOF
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "Error: This operation requires root privileges."
        echo "Please run with sudo: sudo block_social"
        exit 1
    fi
}

print_status() {
    echo "Block Social - Status"
    echo "====================="
    echo

    # Check if hosts file contains our marker
    if grep -q "# BLOCK_SOCIAL_START" "$HOSTS_FILE" 2>/dev/null; then
        echo "Status: BLOCKING ENABLED"
        echo

        # Count blocked entries
        local count
        count=$(grep -c "^0.0.0.0" "$HOSTS_FILE" 2>/dev/null || echo "0")
        echo "Blocked entries: $count"

        # Check backup
        if [[ -f "$BACKUP_FILE" ]]; then
            echo "Backup file: $BACKUP_FILE (exists)"
        else
            echo "Backup file: NOT FOUND (unblock may not work correctly)"
        fi
    else
        echo "Status: BLOCKING DISABLED"
        echo
        echo "The hosts file appears to be in its default state."
    fi
}

list_blocked_sites() {
    echo "Sites that will be blocked:"
    echo "==========================="
    echo
    echo "From Steven Black's hosts file:"
    echo "  (Social media, adware, malware - see $HOSTS_URL)"
    echo
    echo "Custom blocked sites:"
    for site in "${CUSTOM_BLOCKED_SITES[@]}"; do
        echo "  - $site"
        # Only show www variant if not a subdomain
        if [[ "$site" != *"."*"."* ]] || [[ "$site" == www.* ]]; then
            [[ "$site" != www.* ]] && echo "  - www.$site"
        fi
    done
}

# -----------------------------------------------------------------------------
# BLOCK / UNBLOCK OPERATIONS
# -----------------------------------------------------------------------------

create_backup() {
    if [[ ! -f "$BACKUP_FILE" ]]; then
        echo "Creating backup of original hosts file..."
        cp "$HOSTS_FILE" "$BACKUP_FILE"
        echo "Backup created at: $BACKUP_FILE"
    else
        echo "Backup already exists at: $BACKUP_FILE"
    fi
}

download_hosts() {
    echo "Downloading Steven Black's hosts file..."

    local temp_file
    temp_file=$(mktemp)

    if ! curl -sS "$HOSTS_URL" -o "$temp_file"; then
        echo "Error: Failed to download hosts file from:"
        echo "  $HOSTS_URL"
        rm -f "$temp_file"
        exit 1
    fi

    # Verify we got something reasonable
    if [[ ! -s "$temp_file" ]] || ! grep -q "0.0.0.0" "$temp_file"; then
        echo "Error: Downloaded file appears invalid"
        rm -f "$temp_file"
        exit 1
    fi

    cat "$temp_file"
    rm -f "$temp_file"
}

add_custom_blocks() {
    local timestamp
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    echo
    echo "# ============================================================================="
    echo "# BLOCK_SOCIAL_START - Custom blocks added by block_social script"
    echo "# Timestamp: $timestamp"
    echo "# To remove: sudo block_social --unblock"
    echo "# ============================================================================="
    echo

    for site in "${CUSTOM_BLOCKED_SITES[@]}"; do
        echo "0.0.0.0 $site"
        # Add www variant if not already a subdomain
        if [[ "$site" != *"."*"."* ]] || [[ "$site" == www.* ]]; then
            [[ "$site" != www.* ]] && echo "0.0.0.0 www.$site"
        fi
    done

    echo
    echo "# BLOCK_SOCIAL_END"
}

enable_blocking() {
    check_root

    echo "Enabling distraction blocking..."
    echo

    # Create backup first
    create_backup

    # Build new hosts file
    echo "Building new hosts file..."
    local temp_file
    temp_file=$(mktemp)

    {
        download_hosts
        add_custom_blocks
    } > "$temp_file"

    # Verify the temp file looks reasonable
    if [[ ! -s "$temp_file" ]]; then
        echo "Error: Generated hosts file is empty"
        rm -f "$temp_file"
        exit 1
    fi

    # Install new hosts file
    echo "Installing new hosts file..."
    mv "$temp_file" "$HOSTS_FILE"
    chmod 644 "$HOSTS_FILE"

    # Flush DNS cache (macOS)
    echo "Flushing DNS cache..."
    if command -v dscacheutil &>/dev/null; then
        dscacheutil -flushcache
        killall -HUP mDNSResponder 2>/dev/null || true
    fi

    echo
    echo "SUCCESS: Distraction blocking is now ENABLED"
    echo
    echo "Blocked sites include social media, streaming, and custom sites."
    echo "To disable: sudo block_social --unblock"
}

disable_blocking() {
    check_root

    echo "Disabling distraction blocking..."
    echo

    if [[ ! -f "$BACKUP_FILE" ]]; then
        echo "Error: No backup file found at $BACKUP_FILE"
        echo
        echo "Cannot restore original hosts file automatically."
        echo "You may need to manually restore /etc/hosts or reinstall macOS."
        echo
        echo "A minimal hosts file should contain:"
        echo "  127.0.0.1       localhost"
        echo "  255.255.255.255 broadcasthost"
        echo "  ::1             localhost"
        exit 1
    fi

    echo "Restoring original hosts file from backup..."
    cp "$BACKUP_FILE" "$HOSTS_FILE"
    chmod 644 "$HOSTS_FILE"

    # Flush DNS cache (macOS)
    echo "Flushing DNS cache..."
    if command -v dscacheutil &>/dev/null; then
        dscacheutil -flushcache
        killall -HUP mDNSResponder 2>/dev/null || true
    fi

    echo
    echo "SUCCESS: Distraction blocking is now DISABLED"
    echo
    echo "The original hosts file has been restored."
    echo "Backup preserved at: $BACKUP_FILE"
}

# -----------------------------------------------------------------------------
# MAIN
# -----------------------------------------------------------------------------

main() {
    case "${1:-}" in
        --unblock|-u)
            disable_blocking
            ;;
        --status|-s)
            print_status
            ;;
        --list|-l)
            list_blocked_sites
            ;;
        --help|-h)
            print_usage
            ;;
        "")
            enable_blocking
            ;;
        *)
            echo "Error: Unknown option: $1"
            echo
            print_usage
            exit 1
            ;;
    esac
}

main "$@"
