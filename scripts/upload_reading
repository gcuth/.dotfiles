#!/usr/bin/env bb
; Walk ~/Readings directory and copy epubs onto koboereader if one is connected

(def readings-dir "/home/g/Readings/") ; the place for stuff to read
(def kobo-path "/media/g/KOBOeReader/")

(defn file-extension "Get the extension of a filename" [s]
  (second (re-find #"(\.[a-zA-Z0-9]+)$" s)))

(defn copy-files "Copy a file from inpath to outpath-dir (retaining fname)."
  [inpath outpath-dir]
  (let [outpath (io/file outpath-dir (.getName (io/file inpath)))]
    (if (and (.exists (io/file inpath)) (not (.exists (io/file outpath))))
      (io/copy (io/file inpath) (io/file outpath)))))

(def epubs (->> readings-dir
                (io/file)
                (file-seq)
                (filter #(.isFile %))
                (filter #(= ".epub" (file-extension (.getName %))))))

; actually upload them!
(if (.exists (io/file kobo-path))
  (map copy-files epubs (repeat kobo-path)))
